<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Unified Financial Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #004c4c; /* Darkest Teal */
      color: #ffffff; /* White text */
    }
    
    /* Reusable Component Styles from the Dashboard Theme */
    .card {
        background-color: #006666; /* Dark Teal */
        border: 1px solid #008080; /* Teal */
        border-radius: 0.75rem;
        transition: all 0.3s ease-in-out;
    }
    .btn {
        border-radius: 0.375rem;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    }
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    .btn-primary {
        background-color: #b2d8d8; /* Lightest Teal */
        color: #004c4c; /* Darkest Teal for text */
    }
    .btn-primary:hover:not(:disabled) {
        background-color: #c0dede;
    }
    .btn-secondary {
        background-color: #008080; /* Teal */
        color: #ffffff;
        border: 1px solid #66b2b2; /* Lighter Teal */
    }
    .btn-secondary:hover:not(:disabled) {
        background-color: #66b2b2;
    }
    .btn-danger {
        background-color: #991b1b;
        color: #fef2f2;
        border-color: #7f1d1d;
    }
    .btn-danger:hover:not(:disabled) {
        background-color: #b91c1c;
    }
    .modal-content {
        background-color: #006666;
        border: 1px solid #008080;
        animation: scaleIn 0.3s ease-out forwards;
    }
    
    input, select, textarea {
        background-color: transparent;
        border: 1px solid #008080;
        border-radius: 0.375rem;
        padding: 0.5rem 0.75rem;
        width: 100%;
        transition: all 0.2s ease-in-out;
    }
    select option {
        background-color: #006666;
        color: #ffffff;
    }
    input:focus, select:focus, textarea:focus {
        outline: 2px solid #66b2b2;
        outline-offset: 2px;
        border-color: #66b2b2;
    }
    input[type="checkbox"] {
        width: 1rem;
        height: 1rem;
    }
    .progress-bar-background { background-color: #008080; }
    .progress-bar-fill { 
        background-color: #b2d8d8; 
        transition: width 0.5s ease-in-out, background-color 0.5s ease-in-out;
    }

    /* Tab Styles */
    .tabs { display: flex; gap: 4px; margin-bottom: 16px; flex-wrap: wrap; border-bottom: 1px solid #008080; }
    .tab-btn { background-color: transparent; border: none; border-bottom: 3px solid transparent; color: #94a3b8; padding: 8px 12px; cursor: pointer; border-radius: 4px 4px 0 0; font-weight: 500; transition: all 0.2s ease-in-out; }
    .tab-btn.active { color: #b2d8d8; border-bottom-color: #b2d8d8; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Calendar Styles */
    #calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; sm:gap: 5px; }
    .calendar-day { background-color: #005c5c; border-radius: 6px; padding: 4px; min-height: 80px; font-size: 10px; sm:font-size: 12px; sm:min-height: 100px; sm:padding: 8px; }
    .calendar-day.other-month { background-color: #005252; opacity: 0.6; }
    .calendar-day .day-number { font-weight: bold; }
    .calendar-day.today .day-number {
        border: 2px solid #b2d8d8;
        background-color: #008080;
        border-radius: 50%;
        width: 1.75em;
        height: 1.75em;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .calendar-day .event { font-size: 9px; sm:font-size: 11px; padding: 2px 4px; border-radius: 4px; margin-top: 4px; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .event-bill { background-color: #008080; color: #e0f2f1; }
    .event-goal { background-color: #b2d8d8; color: #004c4c; }


    /* Edit Mode & Drag-and-Drop Styles */
    body:not(.edit-mode) .editing-controls {
        display: none;
    }
    .list-item-draggable {
        cursor: grab;
    }
    .item-dragging {
        opacity: 0.5;
        background: #008080;
    }

    /* Animations */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    .fade-in-up {
        animation: fadeInUp 0.5s ease-out forwards;
    }
    @keyframes scaleIn {
        from {
            opacity: 0;
            transform: scale(0.95);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }
  </style>
</head>
<body class="p-2 sm:p-4">
  <div class="container mx-auto">
    <header class="flex flex-wrap justify-between items-center mb-6 gap-4">
      <h1 class="text-2xl sm:text-3xl font-bold">Financial Dashboard</h1>
      <div class="actions flex items-center gap-2 flex-wrap">
        <button class="btn btn-secondary" id="exportBtn">Export Data</button>
        <label id="importBtn" class="btn btn-secondary">Import Data <input type="file" id="importFile" class="hidden" accept=".json"></label>
        <div id="user-actions-container" class="flex items-center gap-2 flex-wrap">
          <!-- User-specific actions will be injected here -->
        </div>
      </div>
    </header>

    <!-- Tab Navigation -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="dashboard-tab">Dashboard</button>
      <button class="tab-btn" data-tab="check-logs-tab">Check Logs</button>
      <button class="tab-btn" data-tab="bills-tab">Recurring Bills</button>
      <button class="tab-btn" data-tab="calendar-tab">Calendar</button>
      <button class="tab-btn" data-tab="search-tab">Bill History</button>
    </div>

    <!-- Tab Content Area -->
    <div id="tab-contents">
        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content active">
            <div id="emptyState" class="text-center py-24 px-4 card">
                <h2 class="text-xl font-semibold mb-2">Welcome to Your Progress Dashboard</h2>
                <p class="text-slate-300 mb-4">Start by adding your first row and tracker.</p>
                <button class="btn btn-primary" id="addFirstRowBtn">Customize Dashboard</button>
            </div>
            <div id="dashboard" class="space-y-4"></div>
        </div>

        <!-- Check Logs Tab -->
        <div id="check-logs-tab" class="tab-content">
            <div class="card p-4">
                <div class="flex flex-col sm:flex-row flex-wrap justify-between items-center gap-4">
                <h3 class="text-lg font-semibold">New Check Log</h3>
                <div class="flex gap-2 flex-wrap">
                    <button class="btn btn-primary" id="addCheckA">+ Log Check A (1st-15th)</button>
                    <button class="btn btn-primary" id="addCheckB">+ Log Check B (16th-31st)</button>
                </div>
                </div>
            </div>
            <div id="checkLogHistory" class="mt-4 space-y-4"></div>
        </div>

        <!-- Recurring Bills Tab -->
        <div id="bills-tab" class="tab-content">
            <div class="card p-4">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                <h3 class="text-lg font-semibold">Manage Recurring Bills</h3>
                <button class="btn btn-secondary" id="addBillBtn">+ Add New Bill</button>
                </div>
                <div class="overflow-x-auto">
                <table id="billsTable" class="w-full text-sm">
                    <thead>
                    <tr class="border-b border-teal-800">
                        <th class="p-2 text-left font-semibold">Bill Name</th>
                        <th class="p-2 text-left font-semibold">Amount</th>
                        <th class="p-2 text-left font-semibold">Due Day</th>
                        <th class="p-2 text-left font-semibold">Type</th>
                        <th class="p-2 text-left font-semibold">Total to Pay</th>
                        <th class="p-2 text-left font-semibold">Actions</th>
                    </tr>
                    </thead>
                    <tbody id="billsBody"></tbody>
                </table>
                </div>
            </div>
        </div>

        <!-- Calendar Tab -->
        <div id="calendar-tab" class="tab-content">
            <div class="card p-4">
                <div class="flex justify-between items-center mb-4">
                    <button id="prevMonth" class="btn btn-secondary">&lt;</button>
                    <h3 id="calendar-header" class="text-lg sm:text-xl font-semibold text-center">Month Year</h3>
                    <button id="nextMonth" class="btn btn-secondary">&gt;</button>
                </div>
                <div id="calendar-grid-header" class="grid grid-cols-7 text-center mb-2 font-bold text-slate-300 text-xs sm:text-base">
                    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                </div>
                <div id="calendar"></div>
            </div>
        </div>

        <!-- Bill History Search Tab -->
        <div id="search-tab" class="tab-content">
            <div class="card p-4">
                <h3 class="text-lg font-semibold mb-4">Bill Payment History</h3>
                <select id="billSearchSelect" class="mb-4"></select>
                <div id="billHistoryResults"></div>
            </div>
        </div>
    </div>
  </div>
  
  <!-- Modals -->
  <div id="authModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/80 p-4">
    <div class="modal-content card p-6 w-full max-w-md">
        <!-- Login View -->
        <div id="loginView">
            <h2 class="text-xl font-semibold mb-4">Log In</h2>
            <div id="loginError" class="text-red-400 text-sm mb-4 hidden"></div>
            <div class="space-y-4">
                <div>
                    <label for="loginUsername" class="text-sm font-medium text-slate-300 mb-2 block">Username</label>
                    <input type="text" id="loginUsername" placeholder="your_username">
                </div>
                <div>
                    <label for="loginPassword" class="text-sm font-medium text-slate-300 mb-2 block">Password</label>
                    <input type="password" id="loginPassword" placeholder="••••••••">
                </div>
            </div>
            <div class="actions flex justify-between items-center mt-6">
                <button class="btn btn-secondary" id="showCreateAccountBtn">Create Account</button>
                <button class="btn btn-primary" id="loginBtn">Log In</button>
            </div>
        </div>
        <!-- Create Account View -->
        <div id="createAccountView" class="hidden">
            <h2 class="text-xl font-semibold mb-4">Create Account</h2>
            <div id="createAccountError" class="text-red-400 text-sm mb-4 hidden"></div>
            <div class="space-y-4">
                <div>
                    <label for="createUsername" class="text-sm font-medium text-slate-300 mb-2 block">Username</label>
                    <input type="text" id="createUsername" placeholder="choose_a_username">
                </div>
                <div>
                    <label for="createPassword" class="text-sm font-medium text-slate-300 mb-2 block">Password</label>
                    <input type="password" id="createPassword" placeholder="••••••••">
                </div>
                <div>
                    <label for="confirmPassword" class="text-sm font-medium text-slate-300 mb-2 block">Confirm Password</label>
                    <input type="password" id="confirmPassword" placeholder="••••••••">
                </div>
            </div>
            <div class="actions flex justify-between items-center mt-6">
                <button class="btn btn-secondary" id="showLoginBtn">Back to Log In</button>
                <button class="btn btn-primary" id="createAccountBtn">Create Account</button>
            </div>
        </div>
    </div>
  </div>

  <div id="tileModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/80 p-4">
    <div class="modal-content card p-6 w-full max-w-lg">
      <h2 id="modalTitle" class="text-xl font-semibold mb-4">Add New Tracker</h2>
      <div class="form-group">
        <label class="text-sm font-medium text-slate-300 mb-2 block">Choose Template</label>
        <div class="template-selector grid grid-cols-2 sm:grid-cols-3 gap-3 mb-4"></div>
      </div>
      <div id="templateFields"></div>
      <div class="actions flex justify-end gap-2 mt-6">
        <button class="btn btn-secondary" onclick="hideModal('tileModal')">Cancel</button>
        <button class="btn btn-primary" id="saveTileBtn">Save</button>
      </div>
    </div>
  </div>

  <div id="confirmModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/80 p-4">
    <div class="modal-content card p-6 w-full max-w-md">
      <h2 id="confirmModalTitle" class="text-xl font-semibold mb-2">Are you sure?</h2>
      <p id="confirmModalText" class="text-slate-300 mb-6">This action cannot be undone.</p>
      <div class="actions flex justify-end gap-2">
        <button class="btn btn-secondary" id="confirmCancelBtn">Cancel</button>
        <button class="btn btn-danger" id="confirmOkBtn">Confirm</button>
      </div>
    </div>
  </div>
  
  <script>
    // --- Supabase Initialization ---
    const SUPABASE_URL = 'https://dxcvbuwjgswupqyijhav.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4Y3ZidXdqZ3N3dXBxeWlqaGF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyMDgzODMsImV4cCI6MjA3MDc4NDM4M30.fAocl5EEjrqLyY52n95TikqJYu1Injje-FlKtPR6Sjg';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- Combined State Management ---
    const LOCAL_STORAGE_KEY = 'unified-financial-dashboard-v1-local';
    let state = {};
    let currentUser = null;
    let userProfile = null;

    const DEFAULT_STATE = {
      dashboard: {
        rows: [],
        tiles: {},
        nextRowId: 1,
        nextTileId: 1,
        isEditing: false
      },
      checkTracker: {
        bills: [],
        checkLogs: [],
      },
      calendar: {
        currentDate: new Date().toISOString()
      }
    };
    
    async function loadState() {
        if (currentUser) {
            console.log('User is logged in. Fetching data from Supabase...');
            const { data, error } = await supabaseClient
                .from('user_data')
                .select('data')
                .eq('user_id', currentUser.id)
                .single();

            if (error && error.code !== 'PGRST116') { // PGRST116 = no rows found
                console.error('Error fetching user data:', error);
                loadLocalState();
            } else if (data) {
                console.log('Data loaded from Supabase.');
                state = data.data;
                state.dashboard = state.dashboard || DEFAULT_STATE.dashboard;
                state.checkTracker = state.checkTracker || DEFAULT_STATE.checkTracker;
                state.calendar = state.calendar || DEFAULT_STATE.calendar;
                state.dashboard.isEditing = false;
            } else {
                console.log('No data found in Supabase for this user. Starting with default state.');
                state = JSON.parse(JSON.stringify(DEFAULT_STATE));
            }
        } else {
            console.log('No user logged in. Loading from local storage.');
            loadLocalState();
        }
        renderAll();
    }

    function loadLocalState() {
      const saved = localStorage.getItem(LOCAL_STORAGE_KEY);
      if (saved) {
        state = JSON.parse(saved);
        state.dashboard.isEditing = false;
      } else {
        state = JSON.parse(JSON.stringify(DEFAULT_STATE));
      }
    }
    
    async function saveState() {
        if (currentUser) {
            console.log('Saving data to Supabase...');
            const { error } = await supabaseClient
                .from('user_data')
                .upsert({ user_id: currentUser.id, data: state });

            if (error) {
                console.error('Error saving data to Supabase:', error);
                alert('Could not save data to the cloud. Please try again.');
            } else {
                console.log('Data saved to Supabase successfully.');
            }
        } else {
            console.log('User not logged in. Saving to local storage.');
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(state));
            } catch (e) {
                console.error('Failed to save state to local storage:', e);
            }
        }
    }
    
    // --- Dashboard: Template Definitions ---
    const templates = {
      progress: { name: 'Progress', icon: '📊', fields: [ { name: 'title', label: 'Tracker Name', type: 'text', required: true }, { name: 'current', label: 'Current Value', type: 'number', default: 0 }, { name: 'target', label: 'Target Value', type: 'number', default: 100 }, { name: 'unit', label: 'Unit (optional)', type: 'text', placeholder: 'e.g., tasks, miles' } ] },
      savings: { name: 'Savings', icon: '💰', fields: [ { name: 'title', label: 'Goal Name', type: 'text', required: true }, { name: 'current', label: 'Current Amount', type: 'number', default: 0 }, { name: 'target', label: 'Target Amount', type: 'number', default: 1000 }, { name: 'targetDate', label: 'Target Date', type: 'date' }, { name: 'currency', label: 'Currency', type: 'select', options: ['USD', 'EUR', 'GBP', 'JPY'], default: 'USD' } ] },
      utilization: { name: 'Utilization', icon: '💳', fields: [ { name: 'title', label: 'Tracker Name', type: 'text', required: true }, { name: 'items', label: 'Items to Track', type: 'dynamic-list', itemFields: [ { name: 'name', label: 'Item Name', type: 'text' }, { name: 'used', label: 'Used', type: 'number' }, { name: 'limit', label: 'Limit', type: 'number' } ]}, { name: 'targetUtil', label: 'Target Utilization %', type: 'number', default: 30 }, { name: 'lowerIsBetter', label: 'Lower usage is better (e.g., credit cards)', type: 'checkbox', default: true }, { name: 'sortBy', type: 'sort', options: ['Order Entered', 'Item Name', 'Used', 'Limit', 'Util%'] }, { name: 'sortAscending', type: 'sort-direction' } ] },
      paymentLog: { name: 'Payment Log', icon: '💸', fields: [ { name: 'title', label: 'Log Name', type: 'text', required: true }, { name: 'currency', label: 'Currency', type: 'select', options: ['USD', 'EUR', 'GBP', 'JPY'], default: 'USD' }, { name: 'sortBy', type: 'sort', options: ['Order Entered', 'Date', 'Amount', 'Description'] }, { name: 'sortAscending', type: 'sort-direction' }, { name: 'payments', label: 'Payments', type: 'payment-entries' } ] },
      countdown: { name: 'Countdown', icon: '⏰', fields: [ { name: 'title', label: 'Event Name', type: 'text', required: true }, { name: 'targetDate', label: 'Target Date', type: 'date', required: true }, { name: 'description', label: 'Description', type: 'textarea' } ] },
      checklist: { name: 'Checklist', icon: '✅', fields: [ { name: 'title', label: 'Checklist Name', type: 'text', required: true }, { name: 'recurrence', label: 'Auto-reset tasks', type: 'select', options: ['None', 'Daily', 'Weekly', 'Monthly'], default: 'None' }, { name: 'sortBy', type: 'sort', options: ['Order Entered', 'Task Name', 'Status'] }, { name: 'sortAscending', type: 'sort-direction' }, { name: 'items', label: 'Tasks', type: 'checklist-items' } ] },
      log: { name: 'Log', icon: '📝', fields: [ { name: 'title', label: 'Log Name', type: 'text', required: true }, { name: 'sortBy', type: 'sort', options: ['Order Entered', 'Date'] }, { name: 'sortAscending', type: 'sort-direction' }, { name: 'entries', label: 'Log Entries', type: 'log-entries' } ] },
      multiTracker: { name: 'Multi-Tracker', icon: '📈', fields: [ { name: 'title', label: 'Tracker Name', type: 'text', required: true }, { name: 'items', label: 'Tracked Items', type: 'multi-tracker-items' } ] }
    };
    
    // --- Dashboard: Modal Management ---
    let currentEditId = null, currentAddRowId = null, selectedTemplate = null;
    
    function showAddModal(editId = null, rowId = null) {
      const modal = document.getElementById('tileModal');
      const modalTitle = document.getElementById('modalTitle');
      currentEditId = editId;
      currentAddRowId = rowId;
      if (editId) {
        const tile = state.dashboard.tiles[editId];
        modalTitle.textContent = 'Edit Tracker';
        selectedTemplate = tile.template;
        renderTemplateFields(tile.template, tile.data);
        document.querySelectorAll('.template-card').forEach(card => card.classList.toggle('selected', card.dataset.template === tile.template));
      } else {
        modalTitle.textContent = 'Add New Tracker';
        selectedTemplate = null;
        document.getElementById('templateFields').innerHTML = '';
        document.querySelectorAll('.template-card').forEach(card => card.classList.remove('selected'));
      }
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }
    
    function hideModal(modalId) {
        document.getElementById(modalId).classList.add('hidden');
        if (modalId === 'tileModal') {
            currentEditId = null; selectedTemplate = null; currentAddRowId = null;
        }
        if (modalId === 'authModal') {
            document.getElementById('loginError').classList.add('hidden');
            document.getElementById('createAccountError').classList.add('hidden');
        }
    }
    
    // --- Dashboard: Form & Tile Logic ---
    function renderTemplateFields(templateType, existingData = {}) {
      const template = templates[templateType]; if (!template) return;
      const container = document.getElementById('templateFields'); container.innerHTML = '';
      template.fields.forEach(field => {
        const group = document.createElement('div'); group.className = 'form-group mb-4';
        
        if (field.type !== 'checkbox' && field.type !== 'sort' && field.type !== 'sort-direction') {
            const label = document.createElement('label'); 
            label.className = "text-sm font-medium text-slate-300 mb-2 block"; 
            label.textContent = field.label; 
            if (field.required) label.textContent += ' *'; 
            group.appendChild(label);
        }

        if (field.type === 'select') {
          const select = document.createElement('select'); select.name = field.name;
          field.options.forEach(opt => { const option = document.createElement('option'); option.value = opt; option.textContent = opt; select.appendChild(option); });
          select.value = existingData[field.name] || field.default || ''; group.appendChild(select);
        } else if (field.type === 'textarea') {
          const textarea = document.createElement('textarea'); textarea.name = field.name; textarea.value = existingData[field.name] || ''; textarea.className = "min-h-[80px]"; group.appendChild(textarea);
        } else if (field.type === 'dynamic-list') {
          const listContainer = document.createElement('div'); listContainer.className = 'item-list space-y-2'; listContainer.dataset.fieldName = field.name;
          const items = existingData[field.name] || [{}];
          items.forEach(item => addDynamicListItem(listContainer, field.itemFields, item));
          const addBtn = document.createElement('button'); addBtn.className = 'btn btn-secondary mt-2 text-xs px-3 py-1'; addBtn.textContent = '+ Add Item'; addBtn.type = 'button';
          addBtn.onclick = () => addDynamicListItem(listContainer, field.itemFields);
          group.appendChild(listContainer); group.appendChild(addBtn);
        } else if (['checklist-items', 'log-entries', 'payment-entries', 'multi-tracker-items'].includes(field.type)) {
          const note = document.createElement('p'); note.className = 'text-sm text-slate-400'; note.textContent = 'Items can be added after creating the tracker.'; group.appendChild(note);
        } else if (field.type === 'checkbox') {
            const checkLabel = document.createElement('label');
            checkLabel.className = 'flex items-center gap-2 text-sm text-slate-300 cursor-pointer mt-2';
            const input = document.createElement('input');
            input.type = 'checkbox';
            input.name = field.name;
            const isChecked = existingData[field.name] === false ? false : (existingData[field.name] === true ? true : field.default);
            input.checked = isChecked;
            input.className = "w-4 h-4 rounded border-teal-600 bg-transparent text-teal-400 focus:ring-teal-400";
            checkLabel.appendChild(input);
            checkLabel.appendChild(document.createTextNode(field.label));
            group.appendChild(checkLabel);
        } else if (field.type === 'sort') {
            group.innerHTML = `<label class="text-sm font-medium text-slate-300 mb-2 block">Sort By</label>`;
            const sortContainer = document.createElement('div');
            sortContainer.className = 'grid grid-cols-2 gap-4';
            const select = document.createElement('select'); select.name = 'sortBy';
            field.options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.replace(/[^a-zA-Z0-9]/g, ''); // Create a safe value
                option.textContent = opt;
                select.appendChild(option);
            });
            select.value = existingData.sortBy || 'OrderEntered';
            const sortDirectionLabel = document.createElement('label');
            sortDirectionLabel.className = 'flex items-center gap-2 text-sm text-slate-300 cursor-pointer';
            const sortDirectionInput = document.createElement('input');
            sortDirectionInput.type = 'checkbox';
            sortDirectionInput.name = 'sortAscending';
            sortDirectionInput.checked = existingData.sortAscending === true;
            sortDirectionLabel.appendChild(sortDirectionInput);
            sortDirectionLabel.appendChild(document.createTextNode('Ascending'));
            
            sortContainer.appendChild(select);
            sortContainer.appendChild(sortDirectionLabel);
            group.appendChild(sortContainer);
        } else if (field.type !== 'sort-direction') {
          const input = document.createElement('input'); input.type = field.type; input.name = field.name; input.placeholder = field.placeholder || ''; input.value = existingData[field.name] || field.default || ''; group.appendChild(input);
        }
        container.appendChild(group);
      });
    }

    function addDynamicListItem(container, itemFields, itemData = {}) {
      const row = document.createElement('div'); row.className = 'item-row flex gap-2 items-center';
      itemFields.forEach(field => {
        const input = document.createElement('input'); 
        input.type = field.type; 
        input.placeholder = field.label; 
        input.value = itemData[field.name] || ''; 
        input.dataset.fieldName = field.name;
        if (field.name === 'name') {
          input.className = "flex-1";
        } else {
          input.className = "w-20";
        }
        row.appendChild(input);
      });
      const removeBtn = document.createElement('button'); removeBtn.className = 'btn btn-danger text-xs px-2 py-1'; removeBtn.textContent = '×'; removeBtn.type = 'button'; removeBtn.onclick = () => row.remove(); row.appendChild(removeBtn);
      container.appendChild(row);
    }
    
    function saveTile() {
        if (!selectedTemplate) { alert('Please select a template'); return; }
        const template = templates[selectedTemplate];
        const data = {};
        const tile = currentEditId ? state.dashboard.tiles[currentEditId] : null;
        const existingData = tile ? tile.data || {} : {};

        template.fields.forEach(field => {
            const input = document.querySelector(`#templateFields [name="${field.name}"]`);
            if (field.type === 'dynamic-list') {
                const container = document.querySelector(`#templateFields [data-field-name="${field.name}"]`);
                if (container) {
                    data[field.name] = Array.from(container.querySelectorAll('.item-row')).map(row => {
                        const item = {};
                        row.querySelectorAll('input').forEach(inp => {
                            if (inp.dataset.fieldName) {
                                item[inp.dataset.fieldName] = inp.type === 'number' ? Number(inp.value) : inp.value;
                            }
                        });
                        return item;
                    });
                } else {
                    data[field.name] = existingData[field.name] || [];
                }
            } else if (['checklist-items', 'log-entries', 'payment-entries', 'multi-tracker-items'].includes(field.type)) {
                const listKeyMap = { 'checklist-items': 'items', 'log-entries': 'entries', 'payment-entries': 'payments', 'multi-tracker-items': 'items'};
                const listKey = listKeyMap[field.type];
                data[listKey] = existingData[listKey] || [];
            } else if (input) {
                if (input.type === 'checkbox') {
                    data[field.name] = input.checked;
                } else if (field.type !== 'sort' && field.type !== 'sort-direction') {
                    data[field.name] = input.type === 'number' ? Number(input.value) : input.value;
                }
            }
        });
        
        const sortByInput = document.querySelector(`#templateFields [name="sortBy"]`);
        if (sortByInput) data.sortBy = sortByInput.value;

        const sortAscInput = document.querySelector(`#templateFields [name="sortAscending"]`);
        if (sortAscInput) data.sortAscending = sortAscInput.checked;

        if (data.items) {
            data.items.forEach((item, index) => {
                if (!item.id) item.id = (Date.now() + index).toString();
            });
        }

        for (const field of template.fields) { if (field.required && !data[field.name]) { alert(`Please fill in ${field.label}`); return; } }
        
        if (currentEditId) {
            state.dashboard.tiles[currentEditId].data = data;
            state.dashboard.tiles[currentEditId].template = selectedTemplate;
        } else {
            const newTile = { id: state.dashboard.nextTileId++, template: selectedTemplate, data: data, created: new Date().toISOString() };
            state.dashboard.tiles[newTile.id] = newTile;
            const row = state.dashboard.rows.find(r => r.id === currentAddRowId);
            if (row) { row.tileIds.push(newTile.id); }
        }
        saveState();
        renderAll();
        hideModal('tileModal');
    }
    
    function deleteTile(id) {
      showConfirmModal('Delete Tracker', 'Are you sure you want to delete this tracker?', () => {
        const rowIndex = state.dashboard.rows.findIndex(row => row.tileIds.includes(id));
        if (rowIndex > -1) {
            state.dashboard.rows[rowIndex].tileIds = state.dashboard.rows[rowIndex].tileIds.filter(tileId => tileId !== id);
            delete state.dashboard.tiles[id];
            if (state.dashboard.rows[rowIndex].tileIds.length === 0) { state.dashboard.rows.splice(rowIndex, 1); }
            saveState(); renderAll();
        }
      });
    }

    // --- Sorting Utility ---
    function applySorting(list, sortBy, sortAscending) {
        if (!Array.isArray(list)) return [];
        const sortedList = [...list];
        const direction = sortAscending ? 1 : -1;

        sortedList.sort((a, b) => {
            let valA, valB;

            switch (sortBy) {
                case 'Date':
                    valA = new Date(a.date || a.timestamp);
                    valB = new Date(b.date || b.timestamp);
                    break;
                case 'Amount':
                    valA = Number(a.amount);
                    valB = Number(b.amount);
                    break;
                case 'Description':
                    valA = (a.description || '').toLowerCase();
                    valB = (b.description || '').toLowerCase();
                    break;
                case 'TaskName':
                    valA = (a.text || '').toLowerCase();
                    valB = (b.text || '').toLowerCase();
                    break;
                case 'Status':
                    valA = a.checked;
                    valB = b.checked;
                    break;
                case 'ItemName':
                    valA = (a.name || '').toLowerCase();
                    valB = (b.name || '').toLowerCase();
                    break;
                case 'Used':
                    valA = Number(a.used);
                    valB = Number(b.used);
                    break;
                case 'Limit':
                    valA = Number(a.limit);
                    valB = Number(b.limit);
                    break;
                case 'Util':
                    valA = (Number(a.used) || 0) / (Number(a.limit) || 1);
                    valB = (Number(b.used) || 0) / (Number(b.limit) || 1);
                    break;
                default:
                    return 0; // No sorting for 'OrderEntered' or unknown
            }

            if (valA < valB) return -1 * direction;
            if (valA > valB) return 1 * direction;
            return 0;
        });

        return sortedList;
    }
    
    // --- Dashboard: Tile Rendering ---
    function renderTile(tile) {
      const div = document.createElement('div'); 
      div.className = 'tile card p-4';
      div.dataset.tileId = tile.id;

      const header = document.createElement('div'); header.className = 'tile-header flex justify-between items-center mb-3';
      const titleEl = document.createElement('h3'); titleEl.className = "font-semibold"; titleEl.textContent = tile.data.title || 'Untitled'; header.appendChild(titleEl);
      const actions = document.createElement('div'); actions.className = 'tile-actions editing-controls flex gap-1';
      const editBtn = document.createElement('button'); editBtn.className = 'btn btn-secondary p-1.5 h-7 w-7 text-xs'; editBtn.innerHTML = '✏️'; editBtn.onclick = () => showAddModal(tile.id); actions.appendChild(editBtn);
      const deleteBtn = document.createElement('button'); deleteBtn.className = 'btn btn-danger p-1.5 h-7 w-7 text-xs'; deleteBtn.innerHTML = '🗑️'; deleteBtn.onclick = () => deleteTile(tile.id); actions.appendChild(deleteBtn);
      header.appendChild(actions); div.appendChild(header);
      const content = document.createElement('div');
      switch (tile.template) {
        case 'progress': renderProgressContent(content, tile); break;
        case 'savings': renderSavingsContent(content, tile); break;
        case 'utilization': renderUtilizationContent(content, tile); break;
        case 'paymentLog': renderPaymentLogContent(content, tile); break;
        case 'countdown': renderCountdownContent(content, tile); break;
        case 'checklist': renderChecklistContent(content, tile); break;
        case 'log': renderLogContent(content, tile); break;
        case 'multiTracker': renderMultiTrackerContent(content, tile); break;
      }
      div.appendChild(content); return div;
    }
    
    function renderProgressContent(container, tile) {
      const current = Number(tile.data.current) || 0, target = Number(tile.data.target) || 1;
      const progress = Math.min(100, (current / target) * 100);
      container.innerHTML = `<div class="w-full h-2 rounded-full progress-bar-background overflow-hidden"><div class="progress-bar-fill h-full rounded-full" style="width: ${progress}%;"></div></div> <p class="text-sm text-center mt-2">${progress.toFixed(1)}% Complete</p> <div class="grid grid-cols-2 gap-4 mt-3"> <div><p class="text-sm text-slate-300">Current</p><p class="font-semibold text-lg">${current}${tile.data.unit ? ' ' + tile.data.unit : ''}</p></div> <div><p class="text-sm text-slate-300">Target</p><p class="font-semibold text-lg">${target}${tile.data.unit ? ' ' + tile.data.unit : ''}</p></div> </div>`;
    }
    function renderSavingsContent(container, tile) {
      const current = Number(tile.data.current) || 0, target = Number(tile.data.target) || 1;
      const progress = Math.min(100, (current / target) * 100);
      const currency = tile.data.currency || 'USD';
      const formatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: currency, minimumFractionDigits: 0, maximumFractionDigits: 0 });
      let dateInfoHTML = `<div class="text-sm text-slate-300 h-[1.2em] mb-2">&nbsp;</div>`;
      if (tile.data.targetDate) {
        const daysLeft = Math.ceil((new Date(tile.data.targetDate) - new Date()) / (1000 * 60 * 60 * 24));
        dateInfoHTML = `<div class="text-sm text-slate-300 h-[1.2em] mb-2">${daysLeft >= 0 ? `${daysLeft} days remaining` : 'Target date passed'}</div>`;
      }
      container.innerHTML = `${dateInfoHTML} <div class="w-full h-2 rounded-full progress-bar-background overflow-hidden"><div class="progress-bar-fill h-full rounded-full" style="width: ${progress}%;"></div></div> <div class="grid grid-cols-2 gap-4 mt-3"> <div><p class="text-sm text-slate-300">Saved</p><p class="font-semibold text-lg">${formatter.format(current)}</p></div> <div><p class="text-sm text-slate-300">Goal</p><p class="font-semibold text-lg">${formatter.format(target)}</p></div> </div>`;
    }
    function renderUtilizationContent(container, tile) {
        let items = tile.data.items || [];
        if (!state.dashboard.isEditing && tile.data.sortBy && tile.data.sortBy !== 'OrderEntered') {
            items = applySorting(items, tile.data.sortBy, tile.data.sortAscending);
        }
        const targetUtil = Number(tile.data.targetUtil) || 1;
        const lowerIsBetter = tile.data.lowerIsBetter !== false;

        let totalUsed = 0;
        let totalLimit = 0;
        
        (tile.data.items || []).forEach(item => {
            totalUsed += Number(item.used) || 0;
            totalLimit += Number(item.limit) || 0;
        });
        
        const overallUtil = totalLimit > 0 ? (totalUsed / totalLimit * 100) : 0;
        
        let progressWidth = 0;
        let percentageText = '';

        if (lowerIsBetter) {
            const progressMade = 100 - overallUtil;
            const totalProgressPossible = 100 - targetUtil;
            progressWidth = totalProgressPossible > 0 ? Math.max(0, Math.min(100, (progressMade / totalProgressPossible) * 100)) : 0;
            percentageText = `${overallUtil.toFixed(1)}% (Target: ≤${targetUtil}%)`;
        } else {
            progressWidth = Math.min(100, (overallUtil / targetUtil) * 100);
            percentageText = `${overallUtil.toFixed(1)}% (Goal: ≥${targetUtil}%)`;
        }

        const usageText = `Usage: ${totalUsed} of ${totalLimit}`;

        container.innerHTML = `
            <table class="w-full text-sm mb-4">
                <thead>
                    <tr class="text-slate-300 border-b border-teal-700">
                        <th class="text-left font-medium py-2 pr-2">Item</th>
                        <th class="text-right font-medium py-2 px-2">Used</th>
                        <th class="text-right font-medium py-2 px-2">Limit</th>
                        <th class="text-right font-medium py-2 pl-2">Util%</th>
                    </tr>
                </thead>
                <tbody class="list-container" data-tile-id="${tile.id}" data-list-type="items">
                ${items.map(item => {
                    const used = Number(item.used) || 0;
                    const limit = Number(item.limit) || 0;
                    const util = limit > 0 ? (used / limit * 100) : 0;
                    const draggableClass = state.dashboard.isEditing ? 'list-item-draggable' : '';
                    return `<tr class="border-b border-teal-800 last:border-b-0 ${draggableClass}" draggable="${state.dashboard.isEditing}" data-item-id="${item.id}"><td class="py-2 pr-2">${item.name || 'Unnamed'}</td><td class="py-2 px-2 text-right">${used}</td><td class="py-2 px-2 text-right">${limit}</td><td class="py-2 pl-2 text-right">${util.toFixed(0)}%</td></tr>`;
                }).join('')}
                </tbody>
            </table>
            <div>
                <div class="flex justify-between text-xs text-slate-300 mb-1">
                    <span>${usageText}</span>
                    <span>${percentageText}</span>
                </div>
                <div class="w-full h-2 rounded-full progress-bar-background overflow-hidden">
                    <div class="h-full rounded-full progress-bar-fill" style="width: ${progressWidth}%;"></div>
                </div>
            </div>
        `;
    }
    function renderPaymentLogContent(container, tile) {
        let payments = tile.data.payments || [];
        if (!state.dashboard.isEditing && tile.data.sortBy && tile.data.sortBy !== 'OrderEntered') {
            payments = applySorting(payments, tile.data.sortBy, tile.data.sortAscending);
        }
        const currency = tile.data.currency || 'USD';
        const formatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: currency });
        const totalPaid = (tile.data.payments || []).reduce((sum, p) => sum + (Number(p.amount) || 0), 0);

        let entriesHTML = payments.map((entry, index) => {
            const draggableClass = state.dashboard.isEditing ? 'list-item-draggable' : '';
            return `
            <div class="py-2 border-b border-teal-800 flex justify-between items-center text-sm ${draggableClass}" draggable="${state.dashboard.isEditing}" data-item-id="${entry.id}">
                <div>
                    <p>${entry.description}</p>
                    <p class="text-xs text-slate-400">${new Date(entry.date + 'T00:00:00').toLocaleDateString()}</p>
                </div>
                <div class="flex items-center gap-2">
                    <span class="font-semibold">${formatter.format(entry.amount)}</span>
                    <button class="btn btn-danger p-1.5 h-7 w-7 text-xs editing-controls" onclick="deletePaymentEntry(${tile.id}, '${entry.id}')">×</button>
                </div>
            </div>
        `}).join('');

        container.innerHTML = `
            <div class="editing-controls grid grid-cols-1 md:grid-cols-3 gap-2 mb-4 items-end">
                <div class="flex-1">
                    <label class="text-xs text-slate-300 mb-1 block">Description</label>
                    <input type="text" id="payment-desc-${tile.id}" placeholder="e.g., Monthly Payment" class="text-sm">
                </div>
                <div class="flex-1">
                    <label class="text-xs text-slate-300 mb-1 block">Amount</label>
                    <input type="number" id="payment-amount-${tile.id}" placeholder="100.00" class="text-sm">
                </div>
                <div class="flex items-center gap-2">
                     <div class="flex-1">
                        <label class="text-xs text-slate-300 mb-1 block">Date</label>
                        <input type="date" id="payment-date-${tile.id}" value="${new Date().toISOString().split('T')[0]}" class="text-sm">
                    </div>
                    <button class="btn btn-primary h-9 w-9 flex-shrink-0" onclick="addPaymentEntry(${tile.id})">+</button>
                </div>
            </div>
            <div class="max-h-60 overflow-y-auto pr-2 list-container" data-tile-id="${tile.id}" data-list-type="payments">${entriesHTML || '<p class="text-sm text-slate-400">No payments logged yet.</p>'}</div>
            <div class="flex justify-end items-center mt-3 pt-3 border-t border-teal-700">
                <p class="text-sm">Total Paid: <span class="font-bold text-lg">${formatter.format(totalPaid)}</span></p>
            </div>
        `;
    }
    window.addPaymentEntry = (tileId) => {
        const descInput = document.getElementById(`payment-desc-${tileId}`);
        const amountInput = document.getElementById(`payment-amount-${tileId}`);
        const dateInput = document.getElementById(`payment-date-${tileId}`);
        
        if (amountInput && amountInput.value && dateInput && dateInput.value) {
            const tile = state.dashboard.tiles[tileId];
            if (!tile.data.payments) tile.data.payments = [];
            
            tile.data.payments.push({
                id: Date.now().toString(),
                description: descInput.value.trim() || 'Payment',
                amount: Number(amountInput.value),
                date: dateInput.value
            });
            
            descInput.value = '';
            amountInput.value = '';
            dateInput.value = new Date().toISOString().split('T')[0];
            
            saveState();
            renderAll();
        }
    };
    window.deletePaymentEntry = (tileId, entryId) => {
        const tile = state.dashboard.tiles[tileId];
        if (tile && tile.data.payments) {
            tile.data.payments = tile.data.payments.filter(p => p.id !== entryId);
            saveState();
            renderAll();
        }
    };
    function renderCountdownContent(container, tile) {
        const targetDate = new Date(tile.data.targetDate);
        const now = new Date();
        const diff = targetDate - now;
        let countdownText = 'Event has passed';
        if (diff > 0) {
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            countdownText = `${days}d ${hours}h ${minutes}m`;
        }
        container.innerHTML = `<div class="text-center text-3xl font-bold my-4 ${diff <= 0 ? 'text-red-500' : ''}">${countdownText}</div><div class="text-sm text-center text-slate-300">${targetDate.toLocaleDateString()}</div>${tile.data.description ? `<p class="text-sm text-slate-300 mt-3">${tile.data.description}</p>` : ''}`;
    }
    function renderChecklistContent(container, tile) {
        let items = tile.data.items || [];
        if (!state.dashboard.isEditing && tile.data.sortBy && tile.data.sortBy !== 'OrderEntered') {
            items = applySorting(items, tile.data.sortBy, tile.data.sortAscending);
        }
        const checkedCount = (tile.data.items || []).filter(item => item.checked).length;
        const totalCount = (tile.data.items || []).length;
        const progress = totalCount > 0 ? (checkedCount / totalCount * 100) : 0;
        let listHTML = items.map((item, index) => {
            const draggableClass = state.dashboard.isEditing ? 'list-item-draggable' : '';
            let dueDateHTML = '';
            if (item.dueDate) {
                const dueDate = new Date(item.dueDate + 'T00:00:00');
                const today = new Date();
                today.setHours(0,0,0,0);
                let dateClass = 'text-slate-400';
                if (dueDate < today && !item.checked) {
                    dateClass = 'text-red-400 font-semibold'; // Overdue
                }
                dueDateHTML = `<span class="text-xs ml-auto ${dateClass}">${dueDate.toLocaleDateString(undefined, {month: 'short', day: 'numeric'})}</span>`;
            }
            return `<div class="flex items-center mb-2 ${draggableClass}" draggable="${state.dashboard.isEditing}" data-item-id="${item.id}">
                        <label class="flex-1 flex items-center cursor-pointer text-sm">
                            <input type="checkbox" ${item.checked ? 'checked' : ''} onchange="toggleChecklistItem(${tile.id}, '${item.id}', this.checked)" class="mr-3 h-4 w-4 rounded border-teal-600 bg-transparent text-teal-400 focus:ring-teal-400">
                            <span>${item.text}</span>
                        </label>
                        ${dueDateHTML}
                    </div>`;
        }).join('');
        container.innerHTML = `<div class="w-full h-2 rounded-full progress-bar-background overflow-hidden"><div class="progress-bar-fill h-full rounded-full" style="width: ${progress}%;"></div></div><p class="text-sm text-slate-300 my-2">${checkedCount} of ${totalCount} completed</p><div class="max-h-32 overflow-y-auto my-3 pr-2 list-container" data-tile-id="${tile.id}" data-list-type="items">${listHTML}</div>
        <div class="editing-controls flex flex-col sm:flex-row gap-2 mt-2">
            <input type="text" id="checklist-input-${tile.id}" placeholder="Add new task..." class="flex-1 text-sm">
            <div class="flex gap-2">
                <input type="date" id="checklist-date-${tile.id}" class="text-sm w-full sm:w-36">
                <button class="btn btn-primary px-3 py-1 text-sm" onclick="addChecklistItem(${tile.id})">+</button>
            </div>
        </div>`;
    }
    window.toggleChecklistItem = (tileId, itemId, isChecked) => {
        const tile = state.dashboard.tiles[tileId];
        const item = tile.data.items.find(i => i.id == itemId);
        if (item) {
            item.checked = isChecked;
            saveState();
            renderAll();
        }
    };
    window.addChecklistItem = (tileId) => {
        const input = document.getElementById(`checklist-input-${tileId}`);
        const dateInput = document.getElementById(`checklist-date-${tileId}`);
        if (input && input.value.trim()) {
            const tile = state.dashboard.tiles[tileId];
            if (!tile.data.items) tile.data.items = [];
            tile.data.items.push({ 
                id: Date.now().toString(), 
                text: input.value.trim(), 
                checked: false,
                dueDate: dateInput.value || null
            });
            input.value = '';
            dateInput.value = '';
            saveState();
            renderAll();
        }
    };
    function renderLogContent(container, tile) {
        let entries = tile.data.entries || [];
        if (!state.dashboard.isEditing && tile.data.sortBy && tile.data.sortBy !== 'OrderEntered') {
            entries = applySorting(entries, tile.data.sortBy, tile.data.sortAscending);
        }
        let entriesHTML = entries.map((entry, index) => {
            const draggableClass = state.dashboard.isEditing ? 'list-item-draggable' : '';
            return `<div class="py-2 border-b border-teal-800 flex justify-between items-center ${draggableClass}" draggable="${state.dashboard.isEditing}" data-item-id="${entry.id}"><div><p class="text-sm">${entry.text}</p><p class="text-xs text-slate-400">${new Date(entry.timestamp).toLocaleString()}</p></div><button class="btn btn-danger p-1.5 h-7 w-7 text-xs editing-controls" onclick="deleteLogEntry(${tile.id}, '${entry.id}')">×</button></div>`
        }).join('');
        container.innerHTML = `<div class="editing-controls flex gap-2 mb-3"><input type="text" id="log-input-${tileId}" placeholder="Add new entry..." class="flex-1 text-sm"><button class="btn btn-primary px-3 py-1 text-sm" onclick="addLogEntry(${tile.id})">Add</button></div><div class="max-h-40 overflow-y-auto pr-2 list-container" data-tile-id="${tile.id}" data-list-type="entries">${entriesHTML}</div><div class="flex justify-between items-center mt-2"><p class="text-sm text-slate-300">Total entries: ${entries.length}</p></div>`;
    }
    window.addLogEntry = (tileId) => {
        const input = document.getElementById(`log-input-${tileId}`);
        if (input && input.value.trim()) {
            const tile = state.dashboard.tiles[tileId];
            if (!tile.data.entries) tile.data.entries = [];
            tile.data.entries.unshift({ id: Date.now().toString(), text: input.value.trim(), timestamp: new Date().toISOString() });
            saveState(); renderAll();
        }
    };
    window.deleteLogEntry = (tileId, entryId) => {
        const tile = state.dashboard.tiles[tileId];
        if (tile && tile.data.entries) {
            tile.data.entries = tile.data.entries.filter(e => e.id != entryId);
            saveState();
            renderAll();
        }
    };
    function renderMultiTrackerContent(container, tile) {
        const items = tile.data.items || [];
        container.innerHTML = `
            <div class="space-y-3">${items.map(item => renderMultiTrackerItem(tile.id, item)).join('')}</div>
            <div class="editing-controls mt-4">
                <button class="btn btn-secondary text-xs" onclick="addMultiTrackerItem(${tile.id})">+ Add Item</button>
            </div>
        `;
    }
    function renderMultiTrackerItem(tileId, item) {
        const current = Number(item.current) || 0;
        const target = Number(item.target) || 1;
        const progress = Math.min(100, (current / target) * 100);
        const lowerIsBetter = item.lowerIsBetter || false;
        
        let barClass = 'progress-bar-fill';
        if (lowerIsBetter) {
            if (progress > 80) barClass = 'bg-red-500';
            else if (progress > 50) barClass = 'bg-yellow-400';
        }

        const displayProgress = lowerIsBetter ? 100 - progress : progress;

        return `
            <div class="multi-tracker-item" data-item-id="${item.id}">
                <div class="flex justify-between items-center text-sm mb-1">
                    <span class="font-medium">${item.name || 'Unnamed'}</span>
                    <span class="text-slate-300">${current} / ${target} ${item.unit || ''}</span>
                </div>
                <div class="w-full h-2 rounded-full progress-bar-background overflow-hidden">
                    <div class="${barClass} h-full rounded-full" style="width: ${displayProgress}%;"></div>
                </div>
                <div class="editing-controls flex items-center gap-2 mt-2">
                    <input type="number" value="${current}" onchange="updateMultiTrackerItem(${tileId}, '${item.id}', 'current', this.value)" placeholder="Current" class="text-sm p-1 w-20">
                    <input type="number" value="${target}" onchange="updateMultiTrackerItem(${tileId}, '${item.id}', 'target', this.value)" placeholder="Target" class="text-sm p-1 w-20">
                    <input type="text" value="${item.name || ''}" onchange="updateMultiTrackerItem(${tileId}, '${item.id}', 'name', this.value)" placeholder="Name" class="text-sm p-1 flex-1">
                    <input type="text" value="${item.unit || ''}" onchange="updateMultiTrackerItem(${tileId}, '${item.id}', 'unit', this.value)" placeholder="Unit" class="text-sm p-1 w-20">
                    <label class="flex items-center gap-1 text-xs"><input type="checkbox" ${lowerIsBetter ? 'checked' : ''} onchange="updateMultiTrackerItem(${tileId}, '${item.id}', 'lowerIsBetter', this.checked)"> Lower is Better</label>
                    <button class="btn btn-danger text-xs px-2 py-1" onclick="deleteMultiTrackerItem(${tileId}, '${item.id}')">×</button>
                </div>
            </div>
        `;
    }
    window.addMultiTrackerItem = (tileId) => {
        const tile = state.dashboard.tiles[tileId];
        if (!tile.data.items) tile.data.items = [];
        tile.data.items.push({
            id: Date.now().toString(),
            name: 'New Metric',
            current: 0,
            target: 100,
            unit: '',
            lowerIsBetter: false
        });
        saveState();
        renderAll();
    };
    window.updateMultiTrackerItem = (tileId, itemId, prop, value) => {
        const tile = state.dashboard.tiles[tileId];
        const item = tile.data.items.find(i => i.id === itemId);
        if (item) {
            if (prop === 'current' || prop === 'target') {
                item[prop] = Number(value);
            } else if (prop === 'lowerIsBetter') {
                item[prop] = value;
            } else {
                item[prop] = value;
            }
            saveState();
            renderAll();
        }
    };
    window.deleteMultiTrackerItem = (tileId, itemId) => {
        const tile = state.dashboard.tiles[tileId];
        if (tile && tile.data.items) {
            tile.data.items = tile.data.items.filter(i => i.id !== itemId);
            saveState();
            renderAll();
        }
    };
    
    // --- Dashboard: Row Rendering & Logic ---
    function renderDashboard() {
      const dashboard = document.getElementById('dashboard');
      const emptyState = document.getElementById('emptyState');
      dashboard.innerHTML = '';
      if (state.dashboard.rows.length === 0) {
        emptyState.style.display = 'block';
        dashboard.style.display = 'none';
      } else {
        emptyState.style.display = 'none';
        dashboard.style.display = 'block';
        state.dashboard.rows.forEach(row => {
            const rowDiv = document.createElement('div'); 
            rowDiv.className = 'dashboard-row card p-4 fade-in-up';
            rowDiv.dataset.rowId = row.id;
            const rowHeader = document.createElement('div'); rowHeader.className = 'row-header flex flex-wrap justify-between items-center mb-4 pb-4 border-b border-teal-800';
            const layoutContainer = document.createElement('div'); layoutContainer.className = 'layout-dropdown-container editing-controls relative';
            const layoutButton = document.createElement('button'); layoutButton.className = 'btn btn-secondary text-sm'; layoutButton.innerHTML = `Layout: ${row.layout === 'auto' ? 'Auto' : row.layout} <span class="ml-1">&#9662;</span>`; layoutButton.onclick = (e) => { e.stopPropagation(); toggleLayoutDropdown(row.id); };
            const dropdownMenu = document.createElement('div'); dropdownMenu.id = `layout-dropdown-${row.id}`; dropdownMenu.className = 'layout-dropdown hidden absolute bg-teal-900 border border-teal-700 rounded-md p-1 mt-2 w-36 shadow-lg z-10';
            ['auto', '1', '2', '3', '4'].forEach(l => {
                const item = document.createElement('button'); item.className = 'w-full text-left px-2 py-1.5 text-sm rounded-sm hover:bg-teal-800'; item.textContent = l === 'auto' ? 'Auto' : `${l} Column${l !== '1' ? 's' : ''}`; item.onclick = () => changeRowLayout(row.id, l); dropdownMenu.appendChild(item);
            });
            layoutContainer.appendChild(layoutButton); layoutContainer.appendChild(dropdownMenu);
            const rowActions = document.createElement('div'); rowActions.className = 'actions editing-controls flex gap-2';
            const addTrackerBtn = document.createElement('button'); addTrackerBtn.className = 'btn btn-primary text-sm'; addTrackerBtn.textContent = '+ Add Tracker'; addTrackerBtn.onclick = () => showAddModal(null, row.id);
            const deleteRowBtn = document.createElement('button'); deleteRowBtn.className = 'btn btn-danger text-sm'; deleteRowBtn.textContent = 'Delete Row'; deleteRowBtn.onclick = () => deleteRow(row.id);
            rowActions.appendChild(addTrackerBtn); rowActions.appendChild(deleteRowBtn);
            rowHeader.appendChild(layoutContainer); rowHeader.appendChild(rowActions);
            const gridDiv = document.createElement('div'); gridDiv.className = 'dashboard-grid grid gap-4';
            gridDiv.style.gridTemplateColumns = (row.layout && row.layout !== 'auto') ? `repeat(${row.layout}, 1fr)` : 'repeat(auto-fit, minmax(280px, 1fr))';
            row.tileIds.forEach(tileId => { const tile = state.dashboard.tiles[tileId]; if(tile) gridDiv.appendChild(renderTile(tile)); });
            rowDiv.appendChild(rowHeader); rowDiv.appendChild(gridDiv); dashboard.appendChild(rowDiv);
        });
      }
      document.body.classList.toggle('edit-mode', state.dashboard.isEditing);
      if (state.dashboard.isEditing) {
          initListItemDragAndDrop();
      }
    }

    function toggleEditMode() {
        state.dashboard.isEditing = !state.dashboard.isEditing;
        renderDashboard(); 
        const editBtn = document.getElementById('editDashboardBtn');
        editBtn.textContent = state.dashboard.isEditing ? 'Done Editing' : 'Edit Dashboard';
        editBtn.classList.toggle('btn-primary', state.dashboard.isEditing);
        editBtn.classList.toggle('btn-secondary', !state.dashboard.isEditing);
    }
    
    function addRow() {
        state.dashboard.rows.push({ id: state.dashboard.nextRowId++, layout: 'auto', tileIds: [] });
        saveState(); renderDashboard();
    }

    function customizeDashboard() {
        if (state.dashboard.rows.length === 0) {
            addRow();
        }
        if (!state.dashboard.isEditing) {
            toggleEditMode();
        }
    }

    function deleteRow(rowId) {
        showConfirmModal('Delete Row', 'This will delete the entire row and all its trackers.', () => {
            const row = state.dashboard.rows.find(r => r.id === rowId);
            if (row) {
                row.tileIds.forEach(tileId => { delete state.dashboard.tiles[tileId]; });
                state.dashboard.rows = state.dashboard.rows.filter(r => r.id !== rowId);
                saveState(); renderAll();
            }
        });
    }
    function changeRowLayout(rowId, layout) {
        const row = state.dashboard.rows.find(r => r.id === rowId);
        if (row) { row.layout = layout; saveState(); renderDashboard(); }
    }
    function toggleLayoutDropdown(rowId) {
        document.querySelectorAll('.layout-dropdown').forEach(d => { if (d.id !== `layout-dropdown-${rowId}`) d.classList.add('hidden'); });
        document.getElementById(`layout-dropdown-${rowId}`).classList.toggle('hidden');
    }

    // --- List Item Drag and Drop Logic ---
    function initListItemDragAndDrop() {
        const draggables = document.querySelectorAll('.list-item-draggable');
        const containers = document.querySelectorAll('.list-container');

        draggables.forEach(draggable => {
            draggable.addEventListener('dragstart', () => {
                draggable.classList.add('item-dragging');
            });

            draggable.addEventListener('dragend', () => {
                draggable.classList.remove('item-dragging');
            });
        });

        containers.forEach(container => {
            container.addEventListener('dragover', e => {
                e.preventDefault();
                const afterElement = getDragAfterElement(container, e.clientY);
                const dragging = document.querySelector('.item-dragging');
                if (dragging && container.contains(dragging)) {
                    if (afterElement == null) {
                        container.appendChild(dragging);
                    } else {
                        container.insertBefore(dragging, afterElement);
                    }
                }
            });

            container.addEventListener('drop', e => {
                e.preventDefault();
                const tileId = parseInt(container.dataset.tileId);
                const listType = container.dataset.listType;
                const tile = state.dashboard.tiles[tileId];

                if (!tile || !tile.data[listType]) return;

                const newIdOrder = Array.from(container.children)
                    .map(child => child.dataset.itemId)
                    .filter(id => id);

                const currentList = tile.data[listType].filter(item => item && item.id);

                currentList.sort((a, b) => {
                    return newIdOrder.indexOf(a.id.toString()) - newIdOrder.indexOf(b.id.toString());
                });
                
                tile.data[listType] = currentList;
                
                saveState();
                renderAll(); 
            });
        });
    }

    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.list-item-draggable:not(.item-dragging)')];

        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }
    
    // --- Check Tracker: Rendering ---
    function renderBills() {
        const tbody = document.getElementById('billsBody');
        tbody.innerHTML = '';
        state.checkTracker.bills.forEach(bill => {
          const tr = document.createElement('tr');
          tr.className = 'border-b border-teal-800 last:border-b-0';
          tr.innerHTML = `
            <td class="p-2"><input type="text" value="${bill.name}" data-id="${bill.id}" data-prop="name" class="bill-input"></td>
            <td class="p-2"><input type="number" value="${bill.amount}" data-id="${bill.id}" data-prop="amount" class="bill-input"></td>
            <td class="p-2"><input type="number" value="${bill.dueDay}" data-id="${bill.id}" data-prop="dueDay" class="bill-input" min="1" max="31"></td>
            <td class="p-2">
                <select data-id="${bill.id}" data-prop="type" class="bill-input">
                    <option value="ongoing" ${bill.type === 'ongoing' ? 'selected' : ''}>Ongoing</option>
                    <option value="limited" ${bill.type === 'limited' ? 'selected' : ''}>Limited</option>
                </select>
            </td>
            <td class="p-2"><input type="number" value="${bill.totalToPay || ''}" data-id="${bill.id}" data-prop="totalToPay" class="bill-input" ${bill.type !== 'limited' ? 'disabled' : ''}></td>
            <td class="p-2"><button class="btn btn-danger text-xs" data-id="${bill.id}">Remove</button></td>
          `;
          tbody.appendChild(tr);
        });
    }

    function renderCheckLogs() {
        const container = document.getElementById('checkLogHistory');
        container.innerHTML = '';
        [...state.checkTracker.checkLogs].sort((a,b) => b.id - a.id).forEach(log => {
            const card = document.createElement('div');
            card.className = 'card p-4';
            card.dataset.logId = log.id;
            
            const balance = (log.checkAmount || 0) - log.items.reduce((sum, item) => sum + (item.paid ? (item.cost || 0) : 0), 0);
            
            let itemsHtml = log.items.map(item => {
                let runningTotal = 0;
                return `
                    <tr class="${item.paid ? 'text-slate-400 line-through' : ''} border-b border-teal-800 last:border-b-0" data-item-id="${item.id}">
                        <td class="p-2"><input type="checkbox" class="item-paid w-4 h-4" ${item.paid ? 'checked' : ''}></td>
                        <td class="p-2"><input type="text" class="item-input" data-prop="bill" value="${item.bill}"></td>
                        <td class="p-2"><input type="number" class="item-input" data-prop="cost" value="${item.cost}"></td>
                        <td class="p-2"><input type="date" class="item-input" data-prop="dueDate" value="${item.dueDate}"></td>
                        <td class="p-2 running-total text-right"></td>
                        <td class="p-2 running-balance text-right"></td>
                        <td class="p-2"><button class="btn btn-danger remove-item-btn text-xs">X</button></td>
                    </tr>
                `;
            }).join('');

            card.innerHTML = `
                <div class="flex flex-col sm:flex-row flex-wrap justify-between items-center gap-2 mb-4">
                    <h3 class="text-lg font-semibold">${log.name} - ${log.month}/${log.year}</h3>
                    <div class="flex items-center gap-4">
                        <span class="text-sm">Balance: <strong class="log-balance text-lg">${formatCurrency(balance)}</strong></span>
                        <button class="btn btn-danger delete-log-btn">Delete Log</button>
                    </div>
                </div>
                <div class="mb-4 max-w-xs">
                    <label class="text-sm text-slate-300 mb-1 block">Check Amount:</label>
                    <input type="number" class="check-amount-input" value="${log.checkAmount || ''}">
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-teal-800"><th class="p-2 text-left">Paid</th><th class="p-2 text-left">Bill</th><th class="p-2 text-left">Cost</th><th class="p-2 text-left">Due Date</th><th class="p-2 text-right">Paid Total</th><th class="p-2 text-right">New Balance</th><th></th></tr>
                        </thead>
                        <tbody>${itemsHtml}</tbody>
                    </table>
                </div>
                <div class="mt-4">
                    <button class="btn btn-secondary add-item-btn">+ Add One-Time Bill</button>
                </div>
            `;
            container.appendChild(card);
            updateLogCalculations(log, card);
        });
    }

    function renderCalendar() {
        const calendarEl = document.getElementById('calendar');
        const headerEl = document.getElementById('calendar-header');
        calendarEl.innerHTML = '';
        const currentCalendarDate = new Date(state.calendar.currentDate);

        const today = new Date();
        const year = currentCalendarDate.getFullYear();
        const month = currentCalendarDate.getMonth();
        headerEl.textContent = `${currentCalendarDate.toLocaleString('default', { month: 'long' })} ${year}`;

        const firstDayOfMonth = new Date(year, month, 1);
        const lastDayOfMonth = new Date(year, month + 1, 0);
        const firstDayOfWeek = firstDayOfMonth.getDay();

        for (let i = 0; i < firstDayOfWeek; i++) {
            calendarEl.innerHTML += `<div class="calendar-day other-month"></div>`;
        }
        
        for (let day = 1; day <= lastDayOfMonth.getDate(); day++) {
            const isToday = day === today.getDate() && month === today.getMonth() && year === today.getFullYear();
            let dayHtml = `<div class="calendar-day ${isToday ? 'today' : ''}"><div class="day-number">${day}</div>`;
            
            state.checkTracker.bills.forEach(bill => {
                if (bill.dueDay == day) {
                    dayHtml += `<div class="event event-bill">${bill.name} - ${formatCurrency(bill.amount)}</div>`;
                }
            });

            Object.values(state.dashboard.tiles).forEach(tile => {
                if (tile.data.targetDate) {
                    const targetDate = new Date(tile.data.targetDate + 'T00:00:00');
                    if (targetDate.getFullYear() === year && targetDate.getMonth() === month && targetDate.getDate() === day) {
                        dayHtml += `<div class="event event-goal">${tile.data.title}</div>`;
                    }
                }
            });

            dayHtml += `</div>`;
            calendarEl.innerHTML += dayHtml;
        }
    }
      
    function renderBillSearch() {
        const select = document.getElementById('billSearchSelect');
        const results = document.getElementById('billHistoryResults');
        const currentSelection = select.value;
        select.innerHTML = '<option value="">Select a bill to see its history</option>';
        results.innerHTML = '';
        
        state.checkTracker.bills.forEach(bill => {
            select.innerHTML += `<option value="${bill.name}">${bill.name}</option>`;
        });
        select.value = currentSelection;
    }

    // --- Check Tracker: Logic ---
    function formatCurrency(n) {
        return (Number(n) || 0).toLocaleString('en-US', { style: 'currency', currency: 'USD' });
    }
    function handleBillInputChange(e) {
        const id = parseInt(e.target.dataset.id);
        const prop = e.target.dataset.prop;
        const value = e.target.type === 'number' ? parseFloat(e.target.value) : e.target.value;
        const bill = state.checkTracker.bills.find(b => b.id === id);
        if (bill) {
          bill[prop] = value;
          if (prop === 'type' && value === 'ongoing') {
              delete bill.totalToPay;
          }
          saveState();
          renderCalendar();
          if (prop === 'type') { renderBills(); }
        }
    }
      
    function addBill() {
        const bills = state.checkTracker.bills;
        const newId = (bills.length > 0) ? Math.max(...bills.map(b => b.id)) + 1 : 1;
        bills.push({ id: newId, name: 'New Bill', amount: 0, dueDay: 1, type: 'ongoing' });
        saveState();
        renderBills();
    }

    function removeBill(id) {
        state.checkTracker.bills = state.checkTracker.bills.filter(b => b.id !== id);
        saveState();
        renderBills();
        renderCalendar(); 
    }

    function addCheckLog(templateType) {
        const now = new Date();
        const logs = state.checkTracker.checkLogs;
        const newId = (logs.length > 0) ? Math.max(...logs.map(l => l.id)) + 1 : 1;
        const isTemplateA = templateType === 'A';
        
        const items = state.checkTracker.bills
            .filter(bill => isTemplateA ? (bill.dueDay >= 1 && bill.dueDay <= 15) : (bill.dueDay >= 16 && bill.dueDay <= 31))
            .map((bill, index) => ({
                id: index + 1,
                bill: bill.name,
                cost: bill.amount,
                dueDate: `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(bill.dueDay).padStart(2, '0')}`,
                paid: false
            }));

        logs.push({
            id: newId,
            name: `Check ${templateType}`,
            month: now.getMonth() + 1,
            year: now.getFullYear(),
            checkAmount: 0,
            items: items
        });
        saveState();
        renderCheckLogs();
    }
      
    function updateLogCalculations(log, logCard) {
        const totalPaid = log.items.reduce((sum, item) => sum + (item.paid ? (item.cost || 0) : 0), 0);
        const overallBalance = (log.checkAmount || 0) - totalPaid;
        logCard.querySelector('.log-balance').textContent = formatCurrency(overallBalance);

        let runningTotal = 0;
        logCard.querySelectorAll('tbody tr').forEach(tr => {
            const itemId = parseInt(tr.dataset.itemId);
            const item = log.items.find(i => i.id === itemId);
            if (!item) return;

            if (item.paid) {
                runningTotal += (item.cost || 0);
                tr.classList.add('text-slate-400', 'line-through');
            } else {
                tr.classList.remove('text-slate-400', 'line-through');
            }
            
            tr.querySelector('.running-total').textContent = formatCurrency(runningTotal);
            tr.querySelector('.running-balance').textContent = formatCurrency((log.checkAmount || 0) - runningTotal);
        });
    }

    function handleCheckLogInteraction(e) {
        const target = e.target;
        const logCard = target.closest('.card[data-log-id]');
        if (!logCard) return;

        const logId = parseInt(logCard.dataset.logId);
        const log = state.checkTracker.checkLogs.find(l => l.id === logId);
        if (!log) return;

        if (target.classList.contains('add-item-btn')) {
            const newItemId = log.items.length > 0 ? Math.max(...log.items.map(i => i.id)) + 1 : 1;
            log.items.push({ id: newItemId, bill: 'One-time expense', cost: 0, dueDate: new Date().toISOString().split('T')[0], paid: false });
            saveState(); renderCheckLogs();
        } else if (target.classList.contains('delete-log-btn')) {
            showConfirmModal('Delete Check Log', 'Are you sure you want to delete this entire check log?', () => {
                state.checkTracker.checkLogs = state.checkTracker.checkLogs.filter(l => l.id !== logId);
                saveState(); renderCheckLogs();
            });
        } else if (target.classList.contains('remove-item-btn')) {
            const itemRow = target.closest('tr[data-item-id]');
            if (itemRow) {
                const itemId = parseInt(itemRow.dataset.itemId);
                log.items = log.items.filter(i => i.id !== itemId);
                saveState(); renderCheckLogs();
            }
        } else if (target.classList.contains('check-amount-input')) {
            log.checkAmount = parseFloat(target.value) || 0;
            saveState(); updateLogCalculations(log, logCard);
        } else {
            const itemRow = target.closest('tr[data-item-id]');
            if (itemRow) {
                const itemId = parseInt(itemRow.dataset.itemId);
                const item = log.items.find(i => i.id === itemId);
                if (item) {
                    if (target.classList.contains('item-paid')) {
                        item.paid = target.checked;
                    } else {
                        const prop = target.dataset.prop;
                        item[prop] = target.type === 'number' ? parseFloat(target.value) : target.value;
                    }
                    saveState(); updateLogCalculations(log, logCard);
                }
            }
        }
    }

    function showBillHistory(billName) {
        const resultsContainer = document.getElementById('billHistoryResults');
        if (!billName) {
            resultsContainer.innerHTML = '';
            return;
        }
        
        let html = `<h4 class="font-semibold mb-2">History for ${billName}</h4><ul class="list-disc pl-5 space-y-1 text-sm">`;
        let count = 0;
        state.checkTracker.checkLogs.forEach(log => {
            log.items.forEach(item => {
                if (item.bill === billName && item.paid) {
                    html += `<li>Paid <strong>${formatCurrency(item.cost)}</strong> on Check ${log.name} (${log.month}/${log.year})</li>`;
                    count++;
                }
            });
        });
        
        if (count === 0) {
            html += '<li>No paid history found for this bill.</li>';
        }
        html += '</ul>';
        resultsContainer.innerHTML = html;
    }

    // --- Global Actions & Confirmation ---
    function exportData() {
        const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `financial-dashboard-export-${new Date().toISOString().split('T')[0]}.json`;
        a.click(); URL.revokeObjectURL(url);
    }
    function importData(file) {
        const reader = new FileReader();
        const fileInput = document.getElementById('importFile');
        reader.onload = (e) => {
            try {
                const imported = JSON.parse(e.target.result);
                if (imported.dashboard && imported.checkTracker) {
                    state = { ...DEFAULT_STATE, ...imported };
                    state.dashboard.isEditing = false;
                    saveState();
                    renderAll();
                    const editBtn = document.getElementById('editDashboardBtn');
                    editBtn.textContent = 'Edit Dashboard';
                    editBtn.classList.remove('btn-primary');
                    editBtn.classList.add('btn-secondary');
                } else { alert('Invalid file format. The file must be a valid export from the Unified Financial Dashboard.'); }
            } catch (err) { alert('Failed to import file: ' + err.message); }
            finally {
                fileInput.value = ''; // Reset the file input
            }
        };
        reader.readAsText(file);
    }
    function resetAllData() {
      showConfirmModal('Reset All Data', 'This will delete everything from all tabs. Are you sure?', () => {
        state = JSON.parse(JSON.stringify(DEFAULT_STATE));
        saveState(); 
        renderAll();
        document.getElementById('importFile').value = '';
      });
    }
    let confirmCallback = null;
    function showConfirmModal(title, text, callback) {
      const modal = document.getElementById('confirmModal');
      document.getElementById('confirmModalTitle').textContent = title;
      document.getElementById('confirmModalText').textContent = text;
      confirmCallback = callback;
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }
    function hideConfirmModal() {
      document.getElementById('confirmModal').classList.add('hidden');
      confirmCallback = null;
    }

    // --- Recurrence Logic ---
    function checkAndApplyRecurrence(tile) {
        const recurrence = tile.data.recurrence;
        if (!recurrence || recurrence === 'None' || !tile.data.items || tile.data.items.length === 0) {
            return false;
        }

        const lastReset = tile.data.lastReset ? new Date(tile.data.lastReset) : null;
        const now = new Date();

        if (!lastReset) {
            tile.data.lastReset = now.toISOString();
            return false;
        }

        let needsReset = false;
        const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const lastResetStart = new Date(lastReset.getFullYear(), lastReset.getMonth(), lastReset.getDate());

        switch (recurrence) {
            case 'Daily':
                if (todayStart.getTime() > lastResetStart.getTime()) {
                    needsReset = true;
                }
                break;
            case 'Weekly':
                const oneWeekInMillis = 7 * 24 * 60 * 60 * 1000;
                if (todayStart.getTime() - lastResetStart.getTime() >= oneWeekInMillis) {
                    needsReset = true;
                }
                break;
            case 'Monthly':
                if (now.getFullYear() > lastReset.getFullYear() || now.getMonth() > lastReset.getMonth()) {
                    needsReset = true;
                }
                break;
        }

        if (needsReset) {
            tile.data.items.forEach(item => item.checked = false);
            tile.data.lastReset = todayStart.toISOString();
            return true;
        }
        
        return false;
    }

    function runStartupChecks() {
        let stateModified = false;
        Object.values(state.dashboard.tiles).forEach(tile => {
            if (tile.template === 'checklist') {
                const didReset = checkAndApplyRecurrence(tile);
                if (didReset) {
                    stateModified = true;
                }
            }
        });

        if (stateModified) {
            console.log("Recurring checklists have been reset.");
            saveState();
        }
    }

    // --- Auth UI and Logic ---
    function renderUserActions() {
        const container = document.getElementById('user-actions-container');
        if (currentUser && userProfile) {
            container.innerHTML = `
                <span class="text-sm hidden sm:inline">Welcome, ${userProfile.username}</span>
                <button class="btn btn-primary" id="saveDataBtn">Save Data</button>
                <button class="btn btn-secondary" id="editDashboardBtn">Edit Dashboard</button>
                <button class="btn btn-primary editing-controls" id="addRowBtn">+ Add New Row</button>
                <button class="btn btn-danger" id="resetBtn">Reset All Data</button>
                <button class="btn btn-secondary" id="logoutBtn">Log Out</button>
            `;
            // Re-attach event listeners for newly created elements
            document.getElementById('saveDataBtn').addEventListener('click', saveState);
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('editDashboardBtn').addEventListener('click', toggleEditMode);
            document.getElementById('addRowBtn').addEventListener('click', addRow);
            document.getElementById('resetBtn').addEventListener('click', resetAllData);
        } else {
            container.innerHTML = `<button class="btn btn-primary" id="showLoginModalBtn">Log In / Sign Up</button>`;
            document.getElementById('showLoginModalBtn').addEventListener('click', () => {
                document.getElementById('authModal').classList.remove('hidden');
                document.getElementById('authModal').classList.add('flex');
            });
        }
    }

    async function login() {
        const username = document.getElementById('loginUsername').value;
        const password = document.getElementById('loginPassword').value;
        const errorDiv = document.getElementById('loginError');
        
        const { error } = await supabaseClient.auth.signInWithPassword({ 
            email: `${username}@example.com`, 
            password 
        });

        if (error) {
            errorDiv.textContent = "Invalid username or password.";
            errorDiv.classList.remove('hidden');
        } else {
            hideModal('authModal');
        }
    }

    async function createAccount() {
        const username = document.getElementById('createUsername').value.trim();
        const password = document.getElementById('createPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const errorDiv = document.getElementById('createAccountError');
        errorDiv.classList.add('hidden');

        if (!username || !password) {
            errorDiv.textContent = "Username and password cannot be empty.";
            errorDiv.classList.remove('hidden');
            return;
        }

        if (password !== confirmPassword) {
            errorDiv.textContent = "Passwords do not match.";
            errorDiv.classList.remove('hidden');
            return;
        }

        // 1. Check if username is already taken
        const { data: existingUser, error: checkError } = await supabaseClient
            .from('profiles')
            .select('username')
            .eq('username', username)
            .single();

        if (checkError && checkError.code !== 'PGRST116') { // Ignore "no rows found" error
            errorDiv.textContent = "Error checking username. Please try again.";
            errorDiv.classList.remove('hidden');
            console.error("Username check error:", checkError);
            return;
        }

        if (existingUser) {
            errorDiv.textContent = "Username is already taken.";
            errorDiv.classList.remove('hidden');
            return;
        }

        // 2. Sign up the user with a dummy email
        const { data: authData, error: signUpError } = await supabaseClient.auth.signUp({
            email: `${username}@example.com`,
            password: password
        });

        if (signUpError) {
            errorDiv.textContent = signUpError.message;
            errorDiv.classList.remove('hidden');
            return;
        }

        // 3. Create the public profile
        if (authData.user) {
            const { error: profileError } = await supabaseClient.from('profiles').insert({
                id: authData.user.id,
                username: username
            });

            if (profileError) {
                errorDiv.textContent = "Could not create user profile. Please contact support.";
                errorDiv.classList.remove('hidden');
                // Consider cleaning up the created auth user here if profile creation fails
                return;
            }
        }
        
        hideModal('authModal');
    }

    async function logout() {
        await supabaseClient.auth.signOut();
        // The onAuthStateChange listener will handle the rest
    }


    // --- Main Rendering & Initialization ---
    function renderAll() {
        renderDashboard();
        renderBills();
        renderCheckLogs();
        renderCalendar();
        renderBillSearch();
    }

    function init() {
        // Setup Template Selector for Dashboard
        const templateSelector = document.querySelector('.template-selector');
        templateSelector.innerHTML = Object.entries(templates).map(([key, {name, icon}]) => `
            <div class="template-card p-3 border border-teal-700 rounded-lg cursor-pointer hover:border-teal-500" data-template="${key}">
                <div class="text-2xl mb-1">${icon}</div>
                <div class="text-xs text-slate-300">${name}</div>
            </div>
        `).join('');

        // Tab Switching
        document.querySelector('.tabs').addEventListener('click', e => {
          if (e.target.classList.contains('tab-btn')) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            e.target.classList.add('active');
            document.getElementById(e.target.dataset.tab).classList.add('active');
          }
        });
        
        // Global Listeners
        document.getElementById('exportBtn').addEventListener('click', exportData);
        document.getElementById('importFile').addEventListener('change', (e) => { if (e.target.files[0]) { importData(e.target.files[0]); } });

        // Dashboard Listeners
        document.getElementById('addFirstRowBtn').addEventListener('click', customizeDashboard);
        templateSelector.addEventListener('click', (e) => {
          const card = e.target.closest('.template-card');
          if (card) {
            document.querySelectorAll('.template-card').forEach(c => c.classList.remove('bg-teal-800', 'border-teal-400'));
            card.classList.add('bg-teal-800', 'border-teal-400');
            selectedTemplate = card.dataset.template;
            renderTemplateFields(selectedTemplate);
          }
        });
        document.getElementById('saveTileBtn').addEventListener('click', saveTile);
        
        // Check Tracker Listeners
        document.getElementById('addBillBtn').onclick = addBill;
        document.getElementById('billsBody').addEventListener('change', handleBillInputChange);
        document.getElementById('billsBody').addEventListener('click', e => {
          if (e.target.tagName === 'BUTTON' && e.target.dataset.id) {
            removeBill(parseInt(e.target.dataset.id));
          }
        });
        document.getElementById('addCheckA').onclick = () => addCheckLog('A');
        document.getElementById('addCheckB').onclick = () => addCheckLog('B');
        document.getElementById('checkLogHistory').addEventListener('input', handleCheckLogInteraction);
        document.getElementById('checkLogHistory').addEventListener('click', handleCheckLogInteraction);
        document.getElementById('billSearchSelect').addEventListener('change', e => showBillHistory(e.target.value));

        // Calendar Listeners
        document.getElementById('prevMonth').onclick = () => { 
            const d = new Date(state.calendar.currentDate);
            d.setMonth(d.getMonth() - 1);
            state.calendar.currentDate = d.toISOString();
            saveState(); renderCalendar();
        };
        document.getElementById('nextMonth').onclick = () => { 
            const d = new Date(state.calendar.currentDate);
            d.setMonth(d.getMonth() + 1);
            state.calendar.currentDate = d.toISOString();
            saveState(); renderCalendar();
        };

        // Modal Listeners
        document.getElementById('tileModal').addEventListener('click', (e) => { if (e.target.id === 'tileModal') { hideModal('tileModal'); } });
        document.getElementById('confirmOkBtn').addEventListener('click', () => { if (confirmCallback) { confirmCallback(); } hideConfirmModal(); });
        document.getElementById('confirmCancelBtn').addEventListener('click', hideConfirmModal);
        document.getElementById('confirmModal').addEventListener('click', (e) => { if (e.target.id === 'confirmModal') { hideConfirmModal(); } });
        window.addEventListener('click', (e) => { if (!e.target.closest('.layout-dropdown-container')) { document.querySelectorAll('.layout-dropdown').forEach(d => d.classList.add('hidden')); } });

        // Auth Modal Listeners
        document.getElementById('authModal').addEventListener('click', (e) => { if (e.target.id === 'authModal') { hideModal('authModal'); } });
        document.getElementById('showCreateAccountBtn').addEventListener('click', () => {
            document.getElementById('loginView').classList.add('hidden');
            document.getElementById('createAccountView').classList.remove('hidden');
        });
        document.getElementById('showLoginBtn').addEventListener('click', () => {
            document.getElementById('createAccountView').classList.add('hidden');
            document.getElementById('loginView').classList.remove('hidden');
        });
        document.getElementById('loginBtn').addEventListener('click', login);
        document.getElementById('createAccountBtn').addEventListener('click', createAccount);

        // Supabase Auth State Change Listener
        supabaseClient.auth.onAuthStateChange(async (_event, session) => {
            currentUser = session?.user || null;
            userProfile = null;
            if (currentUser) {
                const { data, error } = await supabaseClient
                    .from('profiles')
                    .select('username')
                    .eq('id', currentUser.id)
                    .single();
                if (error) {
                    console.error("Error fetching user profile:", error);
                } else {
                    userProfile = data;
                }
            }
            renderUserActions();
            await loadState();
            runStartupChecks();
        });
        
        // Set interval to update countdowns
        setInterval(() => {
            if (state.dashboard && state.dashboard.tiles && Object.values(state.dashboard.tiles).some(t => t.template === 'countdown')) {
                renderDashboard();
            }
        }, 1000 * 30);
    }

    // --- Let's Go! ---
    init();
  </script>
</body>
</html>
